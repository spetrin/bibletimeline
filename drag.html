<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Игровое поле с магнитами</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      display: grid;
      place-items: center;
      background: radial-gradient(circle at 18% 18%, #e0f2fe, #bfdbfe 45%, #a5b4fc 85%);
      padding: 24px;
    }
    .board {
      position: relative;
      width: min(92vw, 680px);
      height: min(88vh, 460px);
      background: rgba(255, 255, 255, 0.82);
      border: 1px solid rgba(148, 163, 184, 0.6);
      border-radius: 32px;
      box-shadow: 0 40px 60px rgba(15, 23, 42, 0.28);
      overflow: hidden;
      touch-action: none;
    }
    .hint {
      position: absolute;
      inset: 18px;
      font-size: 0.95rem;
      line-height: 1.45;
      color: #475569;
      pointer-events: none;
    }
    .shape {
      position: absolute;
      display: grid;
      place-items: center;
      font-weight: 600;
      color: #0f172a;
      user-select: none;
      cursor: grab;
      touch-action: none;
      transition: box-shadow 0.35s ease, transform 0.2s ease;
    }
    .shape:active {
      cursor: grabbing;
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.22);
    }
    .shape--magnetized {
      transform: scale(1.04);
      box-shadow: 0 16px 40px rgba(30, 64, 175, 0.25);
    }
    .shape--rect {
      width: 180px;
      height: 120px;
      border-radius: 20px;
      background: linear-gradient(135deg, #0ea5e9, #38bdf8);
      color: #f0f9ff;
      left: 44px;
      top: 48px;
    }
    .shape--circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f97316, #fde68a);
      left: 320px;
      top: 210px;
    }
    .snap-indicator {
      position: absolute;
      width: 68px;
      height: 68px;
      border-radius: 50%;
      border: 2px dashed rgba(59, 130, 246, 0.55);
      background: radial-gradient(circle, rgba(59, 130, 246, 0.12) 0%, rgba(59, 130, 246, 0) 70%);
      pointer-events: none;
      transform: translate(-50%, -50%) scale(0.8);
      opacity: 0;
      transition: opacity 0.15s ease, transform 0.2s ease;
    }
    .snap-indicator.visible {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  </style>
</head>
<body>
  <div class="board" id="board">
    <div class="hint">Перетащите фигуры. Когда они окажутся ближе 80&nbsp;px друг к другу, «магниты» подтянут их вместе.</div>
    <div class="shape shape--rect" data-shape="rectangle">Прямоугольник</div>
    <div class="shape shape--circle" data-shape="circle">Круг</div>
    <div class="snap-indicator" id="snap-indicator"></div>
  </div>

    <script>
    const board = document.getElementById('board');
    const shapes = Array.from(board.querySelectorAll('.shape'));
    const indicator = document.getElementById('snap-indicator');

    const MAGNET_RADIUS = 100; // px ? ???? ??????????
    const SNAP_OFFSET = 12; // px ? ?????????? ????? ???????? ????? ??????????
    const MAGNET_STRENGTH = 0.45; // 0..1 ? ????????? ?????? ?????? ??????? ??? ???????????

    let activeShape = null;
    let pointerId = null;
    let offsetX = 0;
    let offsetY = 0;

    function getCenter(el) {
      return {
        x: el.offsetLeft + el.offsetWidth / 2,
        y: el.offsetTop + el.offsetHeight / 2,
      };
    }

    function distance(a, b) {
      return Math.hypot(a.x - b.x, a.y - b.y);
    }

    function findSnapTarget(movingShape) {
      const movingCenter = getCenter(movingShape);
      let bestTarget = null;
      let minDist = Infinity;

      for (const other of shapes) {
        if (other === movingShape) continue;
        const otherCenter = getCenter(other);
        const dist = distance(movingCenter, otherCenter);
        if (dist < minDist) {
          minDist = dist;
          bestTarget = { element: other, center: otherCenter, distance: dist };
        }
      }

      if (!bestTarget || bestTarget.distance > MAGNET_RADIUS) return null;

      const { element: other, center: otherCenter } = bestTarget;
      const movingHalfWidth = movingShape.offsetWidth / 2;
      const movingHalfHeight = movingShape.offsetHeight / 2;
      const otherHalfWidth = other.offsetWidth / 2;
      const otherHalfHeight = other.offsetHeight / 2;

      const movingCenter = getCenter(movingShape);
      const dx = movingCenter.x - otherCenter.x;
      const dy = movingCenter.y - otherCenter.y;
      const angle = Math.atan2(dy, dx);

      const targetLeft = other.offsetLeft + otherHalfWidth + Math.cos(angle) * (otherHalfWidth + movingHalfWidth + SNAP_OFFSET) - movingHalfWidth;
      const targetTop = other.offsetTop + otherHalfHeight + Math.sin(angle) * (otherHalfHeight + movingHalfHeight + SNAP_OFFSET) - movingHalfHeight;

      return { left: targetLeft, top: targetTop, center: otherCenter };
    }

    function clampPosition({ element, left, top }) {
      const maxLeft = board.clientWidth - element.offsetWidth;
      const maxTop = board.clientHeight - element.offsetHeight;
      return {
        left: Math.min(Math.max(0, left), maxLeft),
        top: Math.min(Math.max(0, top), maxTop),
      };
    }

    function applySnap(movingShape) {
      const snap = findSnapTarget(movingShape);
      if (!snap) {
        hideIndicator();
        movingShape.classList.remove('shape--magnetized');
        return false;
      }

      const clamped = clampPosition({ element: movingShape, left: snap.left, top: snap.top });
      movingShape.style.left = `${clamped.left}px`;
      movingShape.style.top = `${clamped.top}px`;
      showIndicator(snap.center.x, snap.center.y);
      movingShape.classList.add('shape--magnetized');
      return true;
    }

    function showIndicator(x, y) {
      indicator.style.left = `${x}px`;
      indicator.style.top = `${y}px`;
      indicator.classList.add('visible');
    }

    function hideIndicator() {
      indicator.classList.remove('visible');
    }

    function startDrag(event) {
      if (!event.target.classList.contains('shape')) return;

      activeShape = event.target;
      pointerId = event.pointerId ?? 'mouse';

      if (activeShape.setPointerCapture) {
        try {
          activeShape.setPointerCapture(event.pointerId);
        } catch (_) {
          // ??????????: ??????? ????? ?? ???????????? capture (iOS Safari)
        }
      }

      const rect = activeShape.getBoundingClientRect();
      offsetX = event.clientX - rect.left;
      offsetY = event.clientY - rect.top;
    }

    function moveDrag(event) {
      if (!activeShape) return;
      const currentPointerId = event.pointerId ?? 'mouse';
      if (pointerId !== null && currentPointerId !== pointerId) return;

      const boardRect = board.getBoundingClientRect();
      let newLeft = event.clientX - boardRect.left - offsetX;
      let newTop = event.clientY - boardRect.top - offsetY;

      const position = clampPosition({ element: activeShape, left: newLeft, top: newTop });
      newLeft = position.left;
      newTop = position.top;

      const snap = findSnapTarget(activeShape);
      if (snap) {
        showIndicator(snap.center.x, snap.center.y);
        activeShape.classList.add('shape--magnetized');
        newLeft = newLeft + (snap.left - newLeft) * MAGNET_STRENGTH;
        newTop = newTop + (snap.top - newTop) * MAGNET_STRENGTH;
      } else {
        hideIndicator();
        activeShape.classList.remove('shape--magnetized');
      }

      activeShape.style.left = `${newLeft}px`;
      activeShape.style.top = `${newTop}px`;
    }

    function endDrag(event) {
      if (!activeShape) return;
      const currentPointerId = event.pointerId ?? 'mouse';
      if (pointerId !== null && currentPointerId !== pointerId) return;

      if (!applySnap(activeShape)) {
        activeShape.classList.remove('shape--magnetized');
      }

      if (activeShape.releasePointerCapture) {
        try {
          activeShape.releasePointerCapture(event.pointerId);
        } catch (_) {
          // ??????????, ???? capture ?? ??????????????
        }
      }

      activeShape = null;
      pointerId = null;
    }

    if ('PointerEvent' in window) {
      board.addEventListener('pointerdown', (event) => {
        startDrag(event);
      });
      window.addEventListener('pointermove', (event) => {
        moveDrag(event);
      });
      window.addEventListener('pointerup', (event) => {
        endDrag(event);
      });
      window.addEventListener('pointercancel', (event) => {
        endDrag(event);
      });
    } else {
      // ?????? ??? ?????? ?????????
      board.addEventListener('mousedown', (event) => {
        startDrag(event);
      });
      window.addEventListener('mousemove', (event) => {
        moveDrag(event);
      });
      window.addEventListener('mouseup', (event) => {
        endDrag(event);
      });

      board.addEventListener('touchstart', (event) => {
        const touch = event.changedTouches[0];
        const simulated = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY,
        });
        simulated.target = event.target;
        startDrag(simulated);
      }, { passive: false });

      window.addEventListener('touchmove', (event) => {
        const touch = event.changedTouches[0];
        const simulated = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY,
        });
        moveDrag(simulated);
        event.preventDefault();
      }, { passive: false });

      window.addEventListener('touchend', (event) => {
        const touch = event.changedTouches[0];
        const simulated = new MouseEvent('mouseup', {
          clientX: touch.clientX,
          clientY: touch.clientY,
        });
        endDrag(simulated);
      });
    }
  </script>

</body>
</html>
